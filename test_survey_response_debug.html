<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SurveyResponse - Magic Link</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success { background-color: #28a745; color: white; }
        .status.error { background-color: #dc3545; color: white; }
        .status.warning { background-color: #ffc107; color: black; }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug SurveyResponse - Magic Link</h1>
        <p>Este teste simula exatamente o que acontece no componente SurveyResponse ap√≥s autentica√ß√£o via magic link.</p>
        
        <div class="test-section info">
            <h3>üìã Configura√ß√£o</h3>
            <p><strong>Supabase URL:</strong> <span id="supabase-url">Carregando...</span></p>
            <p><strong>Status:</strong> <span id="connection-status">Verificando...</span></p>
            <button onclick="initialize()">üîÑ Inicializar</button>
        </div>

        <div class="test-section" id="step-1">
            <h3>1Ô∏è‚É£ Simular Magic Link Flow</h3>
            <p>Gerando magic link e autenticando usu√°rio.</p>
            <button onclick="simulateMagicLink()">‚ñ∂Ô∏è Executar Magic Link</button>
            <div id="magic-link-results"></div>
        </div>

        <div class="test-section" id="step-2">
            <h3>2Ô∏è‚É£ Testar loadSurveyData</h3>
            <p>Simulando exatamente a fun√ß√£o loadSurveyData do componente SurveyResponse.</p>
            <button onclick="testLoadSurveyData()">‚ñ∂Ô∏è Testar loadSurveyData</button>
            <div id="load-survey-results"></div>
        </div>

        <div class="test-section" id="step-3">
            <h3>3Ô∏è‚É£ Debug Detalhado</h3>
            <p>An√°lise detalhada de cada etapa do carregamento.</p>
            <button onclick="detailedDebug()">‚ñ∂Ô∏è Debug Detalhado</button>
            <div id="debug-results"></div>
        </div>

        <div class="test-section" id="step-4">
            <h3>4Ô∏è‚É£ Verificar Pol√≠ticas RLS</h3>
            <p>Testando pol√≠ticas RLS espec√≠ficas para o cen√°rio.</p>
            <button onclick="testRLSPolicies()">‚ñ∂Ô∏è Testar RLS</button>
            <div id="rls-results"></div>
        </div>

        <div class="test-section" id="summary">
            <h3>üìä Diagn√≥stico Final</h3>
            <div id="final-diagnosis">Execute os testes acima para ver o diagn√≥stico.</div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'
        
        const SUPABASE_URL = 'https://mjuxvppexydaeuoernxa.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qdXh2cHBleHlkYWV1b2VybnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NDAzNjYsImV4cCI6MjA2OTAxNjM2Nn0.ECVfL7CLqJj4wSPBY7g5yu_zdfBqbUTCK18MAXHjeTg'
        
        let supabase
        let authenticatedSupabase
        let testSurveyId
        let debugLog = []

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            debugLog.push({ timestamp, message, type })
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`)
        }

        window.initialize = async function() {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
                document.getElementById('supabase-url').textContent = SUPABASE_URL
                
                // Testar conex√£o
                const { data, error } = await supabase.from('surveys').select('count').limit(1)
                
                if (error) {
                    document.getElementById('connection-status').innerHTML = 
                        '<span class="status error">‚ùå Erro: ' + error.message + '</span>'
                    log('Erro de conex√£o: ' + error.message, 'error')
                } else {
                    document.getElementById('connection-status').innerHTML = 
                        '<span class="status success">‚úÖ Conectado</span>'
                    log('Conex√£o estabelecida com sucesso', 'success')
                }
            } catch (error) {
                document.getElementById('connection-status').innerHTML = 
                    '<span class="status error">‚ùå Erro: ' + error.message + '</span>'
                log('Erro na inicializa√ß√£o: ' + error.message, 'error')
            }
        }

        window.simulateMagicLink = async function() {
            const resultsDiv = document.getElementById('magic-link-results')
            resultsDiv.innerHTML = '<p>üîÑ Executando fluxo magic link...</p>'
            log('Iniciando simula√ß√£o do magic link', 'info')
            
            try {
                // 1. Buscar uma pesquisa ativa para teste
                log('Buscando pesquisa ativa para teste', 'info')
                const { data: surveys, error: surveyError } = await supabase
                    .from('surveys')
                    .select('id, title, status, unique_link')
                    .eq('status', 'active')
                    .not('unique_link', 'is', null)
                    .limit(1)
                
                if (surveyError || !surveys || surveys.length === 0) {
                    throw new Error('Nenhuma pesquisa ativa encontrada: ' + (surveyError?.message || 'Lista vazia'))
                }
                
                testSurveyId = surveys[0].id
                log(`Pesquisa encontrada: ${surveys[0].title} (ID: ${testSurveyId})`, 'success')
                
                // 2. Gerar magic link
                log('Gerando magic link', 'info')
                const generateResponse = await fetch(`${SUPABASE_URL}/functions/v1/magic-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'generate',
                        email: 'test@example.com',
                        surveyId: testSurveyId
                    })
                })
                
                if (!generateResponse.ok) {
                    throw new Error(`Erro ao gerar magic link: ${generateResponse.status}`)
                }
                
                const magicLinkData = await generateResponse.json()
                log(`Magic link gerado: token=${magicLinkData.token}`, 'success')
                
                // 3. Usar magic link (autenticar)
                log('Autenticando via magic link', 'info')
                const useResponse = await fetch(`${SUPABASE_URL}/functions/v1/magic-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'use',
                        token: magicLinkData.token,
                        surveyId: testSurveyId
                    })
                })
                
                if (!useResponse.ok) {
                    throw new Error(`Erro ao usar magic link: ${useResponse.status}`)
                }
                
                const authData = await useResponse.json()
                log(`Autentica√ß√£o bem-sucedida: user=${authData.user?.email || 'an√¥nimo'}`, 'success')
                
                // 4. Criar cliente autenticado
                if (authData.access_token) {
                    authenticatedSupabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        global: {
                            headers: {
                                Authorization: `Bearer ${authData.access_token}`
                            }
                        }
                    })
                    log('Cliente Supabase autenticado criado', 'success')
                } else {
                    authenticatedSupabase = supabase
                    log('Usando cliente an√¥nimo (sem access_token)', 'warning')
                }
                
                let results = `<p class="status success">‚úÖ Magic link executado com sucesso!</p>`
                results += `<div class="debug-info">`
                results += `<strong>Survey ID:</strong> ${testSurveyId}<br>`
                results += `<strong>Token:</strong> ${magicLinkData.token}<br>`
                results += `<strong>User:</strong> ${authData.user?.email || 'an√¥nimo'}<br>`
                results += `<strong>Access Token:</strong> ${authData.access_token ? 'Presente' : 'Ausente'}`
                results += `</div>`
                
                resultsDiv.innerHTML = results
                
            } catch (error) {
                log('Erro no fluxo magic link: ' + error.message, 'error')
                resultsDiv.innerHTML = `<p class="status error">‚ùå Erro: ${error.message}</p>`
            }
        }

        window.testLoadSurveyData = async function() {
            const resultsDiv = document.getElementById('load-survey-results')
            resultsDiv.innerHTML = '<p>üîÑ Testando loadSurveyData...</p>'
            
            if (!testSurveyId || !authenticatedSupabase) {
                resultsDiv.innerHTML = '<p class="status warning">‚ö†Ô∏è Execute primeiro o teste de magic link</p>'
                return
            }
            
            log('Iniciando teste loadSurveyData', 'info')
            
            try {
                // Simular exatamente o que o componente SurveyResponse faz
                log(`Carregando pesquisa com ID: ${testSurveyId}`, 'info')
                
                // 1. Carregar dados da pesquisa
                const { data: survey, error: surveyError } = await authenticatedSupabase
                    .from('surveys')
                    .select('*')
                    .eq('id', testSurveyId)
                    .single()
                
                if (surveyError) {
                    log('Erro ao carregar pesquisa: ' + surveyError.message, 'error')
                    throw new Error('Erro ao carregar pesquisa: ' + surveyError.message)
                }
                
                log('Pesquisa carregada com sucesso', 'success')
                
                // 2. Verificar status da pesquisa
                if (survey.status !== 'active') {
                    log(`Pesquisa n√£o est√° ativa: status=${survey.status}`, 'warning')
                    throw new Error('Pesquisa n√£o est√° ativa')
                }
                
                log('Status da pesquisa verificado: ativa', 'success')
                
                // 3. Carregar quest√µes
                log('Carregando quest√µes da pesquisa', 'info')
                const { data: questions, error: questionsError } = await authenticatedSupabase
                    .from('questions')
                    .select('*')
                    .eq('survey_id', testSurveyId)
                    .order('order_index')
                
                if (questionsError) {
                    log('Erro ao carregar quest√µes: ' + questionsError.message, 'error')
                    throw new Error('Erro ao carregar quest√µes: ' + questionsError.message)
                }
                
                log(`Quest√µes carregadas: ${questions.length} quest√µes encontradas`, 'success')
                
                // 4. Verificar se h√° quest√µes
                if (!questions || questions.length === 0) {
                    log('Nenhuma quest√£o encontrada para esta pesquisa', 'warning')
                    throw new Error('Nenhuma quest√£o encontrada')
                }
                
                let results = `<p class="status success">‚úÖ loadSurveyData executado com sucesso!</p>`
                results += `<div class="debug-info">`
                results += `<strong>Survey:</strong> ${survey.title}<br>`
                results += `<strong>Status:</strong> ${survey.status}<br>`
                results += `<strong>Unique Link:</strong> ${survey.unique_link || 'N/A'}<br>`
                results += `<strong>Quest√µes:</strong> ${questions.length}<br>`
                results += `<strong>Primeira Quest√£o:</strong> ${questions[0]?.question_text?.substring(0, 50)}...`
                results += `</div>`
                
                results += `<h5>Quest√µes Encontradas:</h5><ul>`
                questions.forEach((q, i) => {
                    results += `<li><strong>Q${i+1}:</strong> ${q.question_text} (${q.question_type})</li>`
                })
                results += `</ul>`
                
                resultsDiv.innerHTML = results
                
            } catch (error) {
                log('Erro em loadSurveyData: ' + error.message, 'error')
                resultsDiv.innerHTML = `<p class="status error">‚ùå Erro: ${error.message}</p>`
                
                // Mostrar detalhes do erro
                let errorDetails = `<div class="debug-info">`
                errorDetails += `<strong>Erro:</strong> ${error.message}<br>`
                errorDetails += `<strong>Survey ID:</strong> ${testSurveyId}<br>`
                errorDetails += `<strong>Cliente:</strong> ${authenticatedSupabase ? 'Autenticado' : 'An√¥nimo'}`
                errorDetails += `</div>`
                
                resultsDiv.innerHTML += errorDetails
            }
        }

        window.detailedDebug = async function() {
            const resultsDiv = document.getElementById('debug-results')
            resultsDiv.innerHTML = '<p>üîÑ Executando debug detalhado...</p>'
            
            if (!testSurveyId) {
                resultsDiv.innerHTML = '<p class="status warning">‚ö†Ô∏è Execute primeiro o teste de magic link</p>'
                return
            }
            
            log('Iniciando debug detalhado', 'info')
            
            let debugResults = '<h4>üîç Debug Detalhado:</h4>'
            
            try {
                // 1. Testar acesso an√¥nimo
                log('Testando acesso an√¥nimo √† pesquisa', 'info')
                const { data: anonSurvey, error: anonSurveyError } = await supabase
                    .from('surveys')
                    .select('*')
                    .eq('id', testSurveyId)
                    .single()
                
                debugResults += `<p><strong>1. Acesso An√¥nimo √† Survey:</strong> `
                if (anonSurveyError) {
                    debugResults += `‚ùå Erro: ${anonSurveyError.message}</p>`
                    log('Acesso an√¥nimo √† pesquisa falhou: ' + anonSurveyError.message, 'error')
                } else {
                    debugResults += `‚úÖ Sucesso</p>`
                    log('Acesso an√¥nimo √† pesquisa bem-sucedido', 'success')
                }
                
                // 2. Testar acesso an√¥nimo √†s quest√µes
                log('Testando acesso an√¥nimo √†s quest√µes', 'info')
                const { data: anonQuestions, error: anonQuestionsError } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('survey_id', testSurveyId)
                
                debugResults += `<p><strong>2. Acesso An√¥nimo √†s Questions:</strong> `
                if (anonQuestionsError) {
                    debugResults += `‚ùå Erro: ${anonQuestionsError.message}</p>`
                    log('Acesso an√¥nimo √†s quest√µes falhou: ' + anonQuestionsError.message, 'error')
                } else {
                    debugResults += `‚úÖ Sucesso (${anonQuestions.length} quest√µes)</p>`
                    log(`Acesso an√¥nimo √†s quest√µes bem-sucedido: ${anonQuestions.length} quest√µes`, 'success')
                }
                
                // 3. Testar acesso autenticado (se dispon√≠vel)
                if (authenticatedSupabase) {
                    log('Testando acesso autenticado √† pesquisa', 'info')
                    const { data: authSurvey, error: authSurveyError } = await authenticatedSupabase
                        .from('surveys')
                        .select('*')
                        .eq('id', testSurveyId)
                        .single()
                    
                    debugResults += `<p><strong>3. Acesso Autenticado √† Survey:</strong> `
                    if (authSurveyError) {
                        debugResults += `‚ùå Erro: ${authSurveyError.message}</p>`
                        log('Acesso autenticado √† pesquisa falhou: ' + authSurveyError.message, 'error')
                    } else {
                        debugResults += `‚úÖ Sucesso</p>`
                        log('Acesso autenticado √† pesquisa bem-sucedido', 'success')
                    }
                    
                    log('Testando acesso autenticado √†s quest√µes', 'info')
                    const { data: authQuestions, error: authQuestionsError } = await authenticatedSupabase
                        .from('questions')
                        .select('*')
                        .eq('survey_id', testSurveyId)
                    
                    debugResults += `<p><strong>4. Acesso Autenticado √†s Questions:</strong> `
                    if (authQuestionsError) {
                        debugResults += `‚ùå Erro: ${authQuestionsError.message}</p>`
                        log('Acesso autenticado √†s quest√µes falhou: ' + authQuestionsError.message, 'error')
                    } else {
                        debugResults += `‚úÖ Sucesso (${authQuestions.length} quest√µes)</p>`
                        log(`Acesso autenticado √†s quest√µes bem-sucedido: ${authQuestions.length} quest√µes`, 'success')
                    }
                }
                
                // 4. Mostrar log completo
                debugResults += `<h5>üìã Log Completo:</h5>`
                debugResults += `<pre>`
                debugLog.forEach(entry => {
                    debugResults += `[${entry.timestamp}] ${entry.type.toUpperCase()}: ${entry.message}\n`
                })
                debugResults += `</pre>`
                
                resultsDiv.innerHTML = debugResults
                
            } catch (error) {
                log('Erro no debug detalhado: ' + error.message, 'error')
                resultsDiv.innerHTML = `<p class="status error">‚ùå Erro: ${error.message}</p>`
            }
        }

        window.testRLSPolicies = async function() {
            const resultsDiv = document.getElementById('rls-results')
            resultsDiv.innerHTML = '<p>üîÑ Testando pol√≠ticas RLS...</p>'
            
            log('Iniciando teste de pol√≠ticas RLS', 'info')
            
            try {
                let rlsResults = '<h4>üîí Teste de Pol√≠ticas RLS:</h4>'
                
                // Testar diferentes cen√°rios de acesso
                const testCases = [
                    {
                        name: 'Surveys com status ativo',
                        query: () => supabase.from('surveys').select('*').eq('status', 'active')
                    },
                    {
                        name: 'Surveys com unique_link',
                        query: () => supabase.from('surveys').select('*').not('unique_link', 'is', null)
                    },
                    {
                        name: 'Questions de surveys ativas',
                        query: () => supabase.from('questions').select('*, surveys!inner(status)').eq('surveys.status', 'active')
                    },
                    {
                        name: 'Inser√ß√£o de responses',
                        query: () => supabase.from('responses').insert({
                            survey_id: testSurveyId,
                            question_id: 'test-id',
                            response_text: 'test response'
                        })
                    }
                ]
                
                for (const testCase of testCases) {
                    log(`Testando: ${testCase.name}`, 'info')
                    try {
                        const { data, error } = await testCase.query()
                        if (error) {
                            rlsResults += `<p>‚ùå <strong>${testCase.name}:</strong> ${error.message}</p>`
                            log(`${testCase.name} falhou: ${error.message}`, 'error')
                        } else {
                            rlsResults += `<p>‚úÖ <strong>${testCase.name}:</strong> Sucesso (${Array.isArray(data) ? data.length : 'OK'})</p>`
                            log(`${testCase.name} bem-sucedido`, 'success')
                        }
                    } catch (e) {
                        rlsResults += `<p>‚ùå <strong>${testCase.name}:</strong> Exce√ß√£o: ${e.message}</p>`
                        log(`${testCase.name} exce√ß√£o: ${e.message}`, 'error')
                    }
                }
                
                resultsDiv.innerHTML = rlsResults
                
            } catch (error) {
                log('Erro no teste de RLS: ' + error.message, 'error')
                resultsDiv.innerHTML = `<p class="status error">‚ùå Erro: ${error.message}</p>`
            }
        }

        function updateDiagnosis() {
            const diagnosisDiv = document.getElementById('final-diagnosis')
            
            let diagnosis = '<h4>ü©∫ Diagn√≥stico:</h4>'
            
            const errors = debugLog.filter(entry => entry.type === 'error')
            const warnings = debugLog.filter(entry => entry.type === 'warning')
            const successes = debugLog.filter(entry => entry.type === 'success')
            
            diagnosis += `<p><strong>Resumo:</strong> ${successes.length} sucessos, ${warnings.length} avisos, ${errors.length} erros</p>`
            
            if (errors.length > 0) {
                diagnosis += '<h5>‚ùå Erros Encontrados:</h5><ul>'
                errors.forEach(error => {
                    diagnosis += `<li>${error.message}</li>`
                })
                diagnosis += '</ul>'
            }
            
            if (warnings.length > 0) {
                diagnosis += '<h5>‚ö†Ô∏è Avisos:</h5><ul>'
                warnings.forEach(warning => {
                    diagnosis += `<li>${warning.message}</li>`
                })
                diagnosis += '</ul>'
            }
            
            // An√°lise espec√≠fica
            const hasAuthError = errors.some(e => e.message.includes('quest√µes'))
            const hasSurveyAccess = successes.some(s => s.message.includes('pesquisa'))
            
            if (hasAuthError && hasSurveyAccess) {
                diagnosis += '<div class="status error">üîç <strong>Problema Identificado:</strong> Acesso √† pesquisa funciona, mas quest√µes est√£o bloqueadas. Verifique pol√≠ticas RLS para a tabela questions.</div>'
            } else if (errors.length === 0 && successes.length > 0) {
                diagnosis += '<div class="status success">üéâ <strong>Tudo Funcionando:</strong> N√£o foram encontrados problemas nas pol√≠ticas RLS. O problema pode estar na implementa√ß√£o do frontend.</div>'
            }
            
            diagnosisDiv.innerHTML = diagnosis
        }

        // Atualizar diagn√≥stico a cada log
        const originalLog = log
        log = function(message, type = 'info') {
            originalLog(message, type)
            setTimeout(updateDiagnosis, 100)
        }

        // Inicializar automaticamente
        window.addEventListener('load', () => {
            initialize()
        })
    </script>
</body>
</html>